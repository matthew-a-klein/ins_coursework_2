<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <link rel="icon" type="image/svg" href="https://upload.wikimedia.org/wikipedia/commons/4/41/Underground.svg">

        <title>London Underground Crowding information</title>
        
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js">
        </script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js">
        </script>
        <script>
            let dataChart=null;
            let globalData=null;


            function getData(){
                //Construct the query url
                var url = "https://api.tfl.gov.uk/crowding/" +
                document.getElementById('station').value +'/' +
                document.getElementById('day').value;
                //Get the data from the url, supplying the api key
                $.getJSON(url, {app_key: "5d02c52c289048d79d405e41f0579ba8"}, function(data){
                    //Draw the new chart
                    var crowdingData = data.timeBands;
                    globalData = data;
                    if(dataChart ==null){
                        dataChart = new Chart(document.getElementById('chart'),
                        {type: 'bar',
                            data: {
                                labels: crowdingData.map(row => row.timeBand),
                                datasets: [
                                    {
                                    label: 'Crowding',
                                    data: crowdingData.map(row => row.percentageOfBaseLine*100)
                                    }

                                ]  
                                             
                            },
                            options: {
                                scales:{
                                    y: {
                                        max : 100
                                    }
                                }
                            }
                        }
                    )
                     setPeakText();
                    }
                    
                    else{
                        dataChart.destroy();
                        dataChart = new Chart(document.getElementById('chart'),
                        {type: 'bar',
                            data: {
                                labels: crowdingData.map(row => row.timeBand),
                                datasets: [
                                    {
                                    label: 'Crowding',
                                    data: crowdingData.map(row => row.percentageOfBaseLine*100)
                                    }

                                ]                   
                            },
                            options: {
                                scales:{
                                    y: {
                                        max : 100
                                    }
                                }
                            }
                        })

     
                    }
                    
                 })
                 setPeakText();
            }

            function setPeakText(){
                am_peak = document.getElementById("am_peak");
                am_peak.textContent = "AM peak timeband: " + globalData.amPeakTimeBand;

                am_peak = document.getElementById("pm_peak");
                pm_peak.textContent = "AM peak timeband: " + globalData.pmPeakTimeBand
            }
        </script>
    </head>
   
    <body  >
        <h1>Welcome to London Underground crowding information!</h1>
        <p>Here you can find crowding information for the London Underground depending on day and time.</p>
        <p>Choose a day and time to see the crowding information.</p>
        
        <form>
            <label for="station">Select Station:</label>
            <select name="station" id="station">
                <option value="940GZZLUPAC">Paddington</option> 
                <option value="940GZZLUKSX">King's Cross St Pancras</option>
                <option value="940GZZLUEUS">Euston</option> 
                <option value="940GZZLUWLO">Waterloo</option> 
                <option value="940GZZLULNB">London Bridge</option>
                <option value="940GZZLULVT">Liverpool</option>
            </select>
        </form>

        <form >
            <label for="day">Select Day:</label>
            <select name="day" id="day">
                <option value="mon">Monday</option>
                <option value="tue">Tuesday</option>
                <option value="wed">Wednesday</option>
                <option value="thu">Thursday</option>
                <option value="fri">Friday</option>
            </select>
         </form>
         <form> 
            <button type="button" onclick="getData()">Submit!</button>
         </form>
         <div>
            <canvas id="chart"></canvas>
         </div>
        <div>
            <p id="am_peak"></p>
        </div>
        <div>
            <p id="pm_peak"></p>
        </div>
        

        
       
        
    </body>
</html>